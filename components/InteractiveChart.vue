<template>
  <div class="interactive-chart">
    <div class="chart-header d-flex align-center justify-space-between mb-4">
      <div>
        <h3 class="text-h6 font-weight-bold">{{ title }}</h3>
        <p class="text-body-2 text-grey">{{ subtitle }}</p>
      </div>
      <div class="d-flex gap-2">
        <VBtn
          v-for="period in timePeriods"
          :key="period.value"
          :variant="selectedPeriod === period.value ? 'elevated' : 'outlined'"
          :color="selectedPeriod === period.value ? 'primary' : 'default'"
          size="small"
          @click="selectedPeriod = period.value"
        >
          {{ period.label }}
        </VBtn>
      </div>
    </div>
    
    <div class="chart-container" ref="chartContainer">
      <!-- Performance Chart Area -->
      <svg 
        :width="chartWidth" 
        :height="chartHeight" 
        class="performance-chart"
        @mousemove="handleMouseMove"
        @mouseleave="hideTooltip"
      >
        <!-- Grid Lines -->
        <g class="grid-lines">
          <line
            v-for="i in 5"
            :key="`h-${i}`"
            :x1="0"
            :y1="(chartHeight - 40) / 5 * i + 20"
            :x2="chartWidth"
            :y2="(chartHeight - 40) / 5 * i + 20"
            stroke="rgba(0,0,0,0.1)"
            stroke-width="1"
          />
          <line
            v-for="i in 10"
            :key="`v-${i}`"
            :x1="chartWidth / 10 * i"
            :y1="20"
            :x2="chartWidth / 10 * i"
            :y2="chartHeight - 20"
            stroke="rgba(0,0,0,0.1)"
            stroke-width="1"
          />
        </g>\n        \n        <!-- Data Line -->\n        <path\n          :d=\"chartPath\"\n          fill=\"none\"\n          stroke=\"rgb(var(--v-theme-primary))\"\n          stroke-width=\"3\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n          class=\"data-line\"\n        />\n        \n        <!-- Gradient Fill -->        \n        <defs>\n          <linearGradient id=\"chartGradient\" x1=\"0%\" y1=\"0%\" x2=\"0%\" y2=\"100%\">\n            <stop offset=\"0%\" :stop-color=\"`rgb(var(--v-theme-primary))`\" stop-opacity=\"0.3\" />\n            <stop offset=\"100%\" :stop-color=\"`rgb(var(--v-theme-primary))`\" stop-opacity=\"0.05\" />\n          </linearGradient>\n        </defs>\n        \n        <path\n          :d=\"fillPath\"\n          fill=\"url(#chartGradient)\"\n          class=\"data-fill\"\n        />\n        \n        <!-- Data Points -->\n        <circle\n          v-for=\"(point, index) in chartData\"\n          :key=\"index\"\n          :cx=\"getXPosition(index)\"\n          :cy=\"getYPosition(point.value)\"\n          :r=\"hoveredIndex === index ? 6 : 4\"\n          :fill=\"hoveredIndex === index ? 'rgb(var(--v-theme-primary))' : 'white'\"\n          :stroke=\"'rgb(var(--v-theme-primary))'\"\n          :stroke-width=\"hoveredIndex === index ? 3 : 2\"\n          class=\"data-point\"\n          @mouseenter=\"hoveredIndex = index\"\n          @mouseleave=\"hoveredIndex = -1\"\n        />\n      </svg>\n      \n      <!-- Tooltip -->\n      <div\n        v-if=\"tooltipVisible && hoveredIndex >= 0\"\n        class=\"chart-tooltip\"\n        :style=\"tooltipStyle\"\n      >\n        <div class=\"tooltip-content\">\n          <div class=\"tooltip-date\">{{ chartData[hoveredIndex]?.label }}</div>\n          <div class=\"tooltip-value\">{{ formatValue(chartData[hoveredIndex]?.value) }}</div>\n          <div class=\"tooltip-change\" :class=\"getChangeClass(hoveredIndex)\">\n            {{ getChangeText(hoveredIndex) }}\n          </div>\n        </div>\n      </div>\n    </div>\n    \n    <!-- Chart Legend -->\n    <div class=\"chart-legend mt-4\">\n      <div class=\"d-flex align-center justify-space-between\">\n        <div class=\"d-flex align-center gap-4\">\n          <div class=\"legend-item\">\n            <div class=\"legend-color\" style=\"background: rgb(var(--v-theme-primary))\"></div>\n            <span class=\"text-body-2\">Performance</span>\n          </div>\n          <div class=\"legend-item\">\n            <div class=\"legend-color\" style=\"background: rgba(var(--v-theme-success), 0.7)\"></div>\n            <span class=\"text-body-2\">Target</span>\n          </div>\n        </div>\n        <div class=\"text-body-2 text-grey\">\n          Hover over points for details\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script setup lang=\"ts\">\ninterface ChartDataPoint {\n  label: string;\n  value: number;\n  change?: number;\n}\n\ninterface TimePeriod {\n  label: string;\n  value: string;\n}\n\ninterface Props {\n  title: string;\n  subtitle?: string;\n  data?: ChartDataPoint[];\n  timePeriods?: TimePeriod[];\n}\n\nconst props = withDefaults(defineProps<Props>(), {\n  subtitle: '',\n  data: () => [],\n  timePeriods: () => [\n    { label: '7D', value: '7d' },\n    { label: '30D', value: '30d' },\n    { label: '90D', value: '90d' },\n  ],\n});\n\n// State\nconst selectedPeriod = ref('30d');\nconst hoveredIndex = ref(-1);\nconst tooltipVisible = ref(false);\nconst tooltipStyle = ref({});\nconst chartContainer = ref<HTMLElement>();\n\n// Chart dimensions\nconst chartWidth = ref(800);\nconst chartHeight = ref(300);\n\n// Generate sample data based on selected period\nconst chartData = computed(() => {\n  if (props.data.length > 0) return props.data;\n  \n  const days = selectedPeriod.value === '7d' ? 7 : selectedPeriod.value === '30d' ? 30 : 90;\n  const baseValue = 75;\n  \n  return Array.from({ length: days }, (_, i) => {\n    const date = new Date();\n    date.setDate(date.getDate() - (days - 1 - i));\n    \n    // Generate realistic looking data with trends\n    const trend = Math.sin((i / days) * Math.PI * 2) * 15;\n    const noise = (Math.random() - 0.5) * 10;\n    const value = Math.max(0, Math.min(100, baseValue + trend + noise));\n    \n    return {\n      label: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),\n      value: Math.round(value * 100) / 100,\n      change: i > 0 ? value - (baseValue + Math.sin(((i-1) / days) * Math.PI * 2) * 15) : 0,\n    };\n  });\n});\n\n// Chart path calculations\nconst chartPath = computed(() => {\n  if (chartData.value.length === 0) return '';\n  \n  const points = chartData.value.map((point, index) => {\n    const x = getXPosition(index);\n    const y = getYPosition(point.value);\n    return `${x},${y}`;\n  });\n  \n  return `M ${points.join(' L ')}`;\n});\n\nconst fillPath = computed(() => {\n  if (chartData.value.length === 0) return '';\n  \n  const points = chartData.value.map((point, index) => {\n    const x = getXPosition(index);\n    const y = getYPosition(point.value);\n    return `${x},${y}`;\n  });\n  \n  const firstX = getXPosition(0);\n  const lastX = getXPosition(chartData.value.length - 1);\n  const bottomY = chartHeight.value - 20;\n  \n  return `M ${firstX},${bottomY} L ${points.join(' L ')} L ${lastX},${bottomY} Z`;\n});\n\n// Helper functions\nconst getXPosition = (index: number) => {\n  const padding = 40;\n  const availableWidth = chartWidth.value - (padding * 2);\n  return padding + (availableWidth / (chartData.value.length - 1)) * index;\n};\n\nconst getYPosition = (value: number) => {\n  const padding = 20;\n  const availableHeight = chartHeight.value - (padding * 2);\n  const maxValue = Math.max(...chartData.value.map(d => d.value));\n  const minValue = Math.min(...chartData.value.map(d => d.value));\n  const range = maxValue - minValue || 1;\n  \n  return padding + availableHeight - ((value - minValue) / range) * availableHeight;\n};\n\nconst formatValue = (value: number) => {\n  return `${value.toFixed(1)}%`;\n};\n\nconst getChangeClass = (index: number) => {\n  const change = chartData.value[index]?.change || 0;\n  return change >= 0 ? 'text-success' : 'text-error';\n};\n\nconst getChangeText = (index: number) => {\n  const change = chartData.value[index]?.change || 0;\n  const prefix = change >= 0 ? '+' : '';\n  return `${prefix}${change.toFixed(1)}%`;\n};\n\nconst handleMouseMove = (event: MouseEvent) => {\n  if (!chartContainer.value) return;\n  \n  const rect = chartContainer.value.getBoundingClientRect();\n  const x = event.clientX - rect.left;\n  const y = event.clientY - rect.top;\n  \n  // Find closest data point\n  let closestIndex = -1;\n  let closestDistance = Infinity;\n  \n  chartData.value.forEach((_, index) => {\n    const pointX = getXPosition(index);\n    const distance = Math.abs(x - pointX);\n    \n    if (distance < closestDistance && distance < 30) {\n      closestDistance = distance;\n      closestIndex = index;\n    }\n  });\n  \n  if (closestIndex >= 0) {\n    hoveredIndex.value = closestIndex;\n    tooltipVisible.value = true;\n    \n    tooltipStyle.value = {\n      position: 'absolute',\n      left: `${getXPosition(closestIndex)}px`,\n      top: `${getYPosition(chartData.value[closestIndex].value) - 60}px`,\n      transform: 'translateX(-50%)',\n      pointerEvents: 'none',\n    };\n  } else {\n    hideTooltip();\n  }\n};\n\nconst hideTooltip = () => {\n  tooltipVisible.value = false;\n  hoveredIndex.value = -1;\n};\n\n// Responsive chart sizing\nconst updateChartSize = () => {\n  if (chartContainer.value) {\n    const containerWidth = chartContainer.value.clientWidth;\n    chartWidth.value = Math.max(400, containerWidth);\n  }\n};\n\nonMounted(() => {\n  updateChartSize();\n  window.addEventListener('resize', updateChartSize);\n});\n\nonUnmounted(() => {\n  window.removeEventListener('resize', updateChartSize);\n});\n\n// Watch for period changes to animate\nwatch(selectedPeriod, () => {\n  // Add animation class\n  if (chartContainer.value) {\n    chartContainer.value.classList.add('chart-updating');\n    setTimeout(() => {\n      chartContainer.value?.classList.remove('chart-updating');\n    }, 300);\n  }\n});\n</script>\n\n<style scoped>\n.interactive-chart {\n  padding: 20px;\n}\n\n.chart-container {\n  position: relative;\n  overflow: hidden;\n  border-radius: 12px;\n  background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.6));\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  backdrop-filter: blur(10px);\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n.chart-container:hover {\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);\n}\n\n.performance-chart {\n  width: 100%;\n  height: 100%;\n  cursor: crosshair;\n}\n\n.data-line {\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n  filter: drop-shadow(0 2px 4px rgba(var(--v-theme-primary), 0.3));\n}\n\n.data-fill {\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n.data-point {\n  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n  cursor: pointer;\n}\n\n.data-point:hover {\n  filter: drop-shadow(0 2px 8px rgba(var(--v-theme-primary), 0.5));\n}\n\n.chart-tooltip {\n  background: rgba(0, 0, 0, 0.9);\n  color: white;\n  padding: 12px 16px;\n  border-radius: 8px;\n  font-size: 14px;\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);\n  backdrop-filter: blur(20px);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  z-index: 10;\n  animation: fadeIn 0.2s ease;\n}\n\n.tooltip-content {\n  text-align: center;\n}\n\n.tooltip-date {\n  font-weight: 500;\n  margin-bottom: 4px;\n}\n\n.tooltip-value {\n  font-size: 18px;\n  font-weight: bold;\n  margin-bottom: 4px;\n}\n\n.tooltip-change {\n  font-size: 12px;\n}\n\n.chart-legend {\n  padding: 12px 0;\n}\n\n.legend-item {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.legend-color {\n  width: 12px;\n  height: 12px;\n  border-radius: 2px;\n}\n\n.chart-updating {\n  opacity: 0.7;\n  transition: opacity 0.3s ease;\n}\n\n@keyframes fadeIn {\n  from {\n    opacity: 0;\n    transform: translateX(-50%) translateY(10px);\n  }\n  to {\n    opacity: 1;\n    transform: translateX(-50%) translateY(0);\n  }\n}\n\n/* Responsive design */\n@media (max-width: 768px) {\n  .chart-header {\n    flex-direction: column;\n    align-items: flex-start;\n    gap: 16px;\n  }\n  \n  .interactive-chart {\n    padding: 12px;\n  }\n}\n\n/* Dark mode support */\n:deep(.v-theme--dark) .chart-container {\n  background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));\n  border-color: rgba(255, 255, 255, 0.1);\n}\n\n:deep(.v-theme--dark) .grid-lines line {\n  stroke: rgba(255, 255, 255, 0.1);\n}\n</style>